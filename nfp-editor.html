<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFP Editor - XCC</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00ff88;
            --primary-dark: #00cc6a;
            --secondary-color: #ff6b00;
            --bg-dark: #0a0a0a;
            --bg-darker: #050505;
            --bg-card: #111111;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #707070;
            --border-color: #333333;
            --accent: #00ff88;
            --gradient-1: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Animated background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: var(--bg-dark);
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(0, 255, 136, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 107, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(0, 136, 255, 0.05) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }

        /* Main layout */
        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
        }

        .nav-title {
            font-size: 1.2rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--gradient-1);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px rgba(0, 255, 136, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            background: rgba(0, 255, 136, 0.1);
        }

        /* Main content */
        .main-content {
            flex: 1;
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border-color);
            padding: 2rem;
            overflow-y: auto;
        }

        .tool-section {
            margin-bottom: 2rem;
        }

        .tool-section h3 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tool-btn {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.85rem;
        }

        .tool-btn:hover,
        .tool-btn.active {
            background: rgba(0, 255, 136, 0.1);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Color palette */
        .color-palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .color-btn {
            width: 40px;
            height: 40px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .color-btn:hover {
            transform: scale(1.1);
        }

        .color-btn.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.3);
        }

        .color-btn.transparent {
            background: linear-gradient(45deg, #333 25%, transparent 25%, transparent 75%, #333 75%, #333),
                        linear-gradient(45deg, #333 25%, transparent 25%, transparent 75%, #333 75%, #333);
            background-size: 8px 8px;
            background-position: 0 0, 4px 4px;
        }

        /* Canvas area */
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.2);
        }

        .canvas-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .canvas-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .canvas-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .canvas-container {
            flex: 1;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        .canvas-wrapper {
            position: relative;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        #nfpCanvas {
            background: #222;
            border: 1px solid var(--border-color);
            cursor: crosshair;
            image-rendering: pixelated;
        }

        /* Properties panel */
        .properties-panel {
            width: 300px;
            background: var(--bg-card);
            border-left: 1px solid var(--border-color);
            padding: 2rem;
            overflow-y: auto;
        }

        .property-group {
            margin-bottom: 2rem;
        }

        .property-group h4 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .property-field {
            margin-bottom: 1rem;
        }

        .property-field label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .property-field input,
        .property-field select,
        .property-field textarea {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .property-field input:focus,
        .property-field select:focus,
        .property-field textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.2);
        }

        .property-field textarea {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            min-height: 200px;
            resize: vertical;
        }

        /* Preview section */
        .preview-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .preview-title {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .nfp-preview {
            background: #000;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            line-height: 1;
            padding: 0.5rem;
            border-radius: 4px;
            color: white;
            white-space: pre;
            overflow-x: auto;
        }

        /* Zoom controls */
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .zoom-btn:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: var(--accent);
        }

        .zoom-level {
            color: var(--text-secondary);
            font-size: 0.9rem;
            min-width: 60px;
            text-align: center;
        }

        /* Grid toggle */
        .grid-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--accent);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(20px);
        }

        /* CC colors */
        .cc-white { background-color: #f0f0f0; }
        .cc-orange { background-color: #f2b233; }
        .cc-magenta { background-color: #e57fd8; }
        .cc-lightBlue { background-color: #99b2f2; }
        .cc-yellow { background-color: #dede6c; }
        .cc-lime { background-color: #7fcc19; }
        .cc-pink { background-color: #f2b2cc; }
        .cc-gray { background-color: #4c4c4c; }
        .cc-lightGray { background-color: #999999; }
        .cc-cyan { background-color: #4c99b2; }
        .cc-purple { background-color: #b266e5; }
        .cc-blue { background-color: #3366cc; }
        .cc-brown { background-color: #7f664c; }
        .cc-green { background-color: #57a64e; }
        .cc-red { background-color: #cc4c4c; }
        .cc-black { background-color: #191919; }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar,
            .properties-panel {
                width: 100%;
            }
            
            .canvas-area {
                min-height: 600px;
            }
        }

        /* File upload area */
        .file-upload {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: var(--accent);
            background: rgba(0, 255, 136, 0.05);
        }

        .file-upload input {
            display: none;
        }

        .upload-text {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            color: var(--text-muted);
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <a href="index.html" class="logo">XCC</a>
            <div class="nav-title">NFP Editor</div>
            <div class="nav-actions">
                <a href="index.html" class="btn btn-secondary">‚Üê Back to Home</a>
                <button class="btn btn-primary" onclick="nfpEditor.exportNFP()">üíæ Export NFP</button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Sidebar - Tools -->
        <aside class="sidebar">
            <!-- Tools -->
            <div class="tool-section">
                <h3>üõ†Ô∏è Tools</h3>
                <div class="tool-grid">
                    <div class="tool-btn active" data-tool="brush">‚úèÔ∏è Brush</div>
                    <div class="tool-btn" data-tool="eraser">üßπ Eraser</div>
                    <div class="tool-btn" data-tool="fill">ü™£ Fill</div>
                    <div class="tool-btn" data-tool="line">üìè Line</div>
                    <div class="tool-btn" data-tool="rectangle">‚¨ú Rect</div>
                    <div class="tool-btn" data-tool="circle">‚≠ï Circle</div>
                    <div class="tool-btn" data-tool="eyedropper">üíß Picker</div>
                    <div class="tool-btn" data-tool="move">‚úã Move</div>
                </div>
            </div>

            <!-- Color Palette -->
            <div class="tool-section">
                <h3>üé® Colors</h3>
                <div class="color-palette">
                    <div class="color-btn transparent active" data-color=" " title="Transparent"></div>
                    <div class="color-btn cc-white" data-color="0" title="White"></div>
                    <div class="color-btn cc-orange" data-color="1" title="Orange"></div>
                    <div class="color-btn cc-magenta" data-color="2" title="Magenta"></div>
                    <div class="color-btn cc-lightBlue" data-color="3" title="Light Blue"></div>
                    <div class="color-btn cc-yellow" data-color="4" title="Yellow"></div>
                    <div class="color-btn cc-lime" data-color="5" title="Lime"></div>
                    <div class="color-btn cc-pink" data-color="6" title="Pink"></div>
                    <div class="color-btn cc-gray" data-color="7" title="Gray"></div>
                    <div class="color-btn cc-lightGray" data-color="8" title="Light Gray"></div>
                    <div class="color-btn cc-cyan" data-color="9" title="Cyan"></div>
                    <div class="color-btn cc-purple" data-color="a" title="Purple"></div>
                    <div class="color-btn cc-blue" data-color="b" title="Blue"></div>
                    <div class="color-btn cc-brown" data-color="c" title="Brown"></div>
                    <div class="color-btn cc-green" data-color="d" title="Green"></div>
                    <div class="color-btn cc-red" data-color="e" title="Red"></div>
                    <div class="color-btn cc-black" data-color="f" title="Black"></div>
                </div>
            </div>

            <!-- File Operations -->
            <div class="tool-section">
                <h3>üìÅ File</h3>
                <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".nfp,.txt" onchange="nfpEditor.loadFile(event)">
                    <div class="upload-text">üìÇ Load NFP File</div>
                    <div class="upload-hint">Click to browse or drag & drop</div>
                </div>
                <button class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;" onclick="nfpEditor.newCanvas()">üìÑ New Canvas</button>
                <button class="btn btn-secondary" style="width: 100%;" onclick="nfpEditor.clearCanvas()">üóëÔ∏è Clear All</button>
            </div>
        </aside>

        <!-- Canvas Area -->
        <main class="canvas-area">
            <div class="canvas-header">
                <div class="canvas-info">
                    <span id="canvasSize">Canvas: 64√ó48</span> | 
                    <span id="mousePos">Position: 0, 0</span>
                </div>
                <div class="canvas-controls">
                    <div class="grid-toggle">
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">Grid</span>
                        <div class="toggle-switch" id="gridToggle" onclick="nfpEditor.toggleGrid()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="zoom-controls">
                        <div class="zoom-btn" onclick="nfpEditor.zoomOut()">‚àí</div>
                        <div class="zoom-level" id="zoomLevel">100%</div>
                        <div class="zoom-btn" onclick="nfpEditor.zoomIn()">+</div>
                    </div>
                </div>
            </div>
            
            <div class="canvas-container">
                <div class="canvas-wrapper">
                    <canvas id="nfpCanvas" width="640" height="480"></canvas>
                </div>
            </div>
        </main>

        <!-- Properties Panel -->
        <aside class="properties-panel">
            <!-- Canvas Properties -->
            <div class="property-group">
                <h4>üìê Canvas</h4>
                <div class="property-field">
                    <label>Width</label>
                    <input type="number" id="canvasWidth" value="64" min="1" max="200" onchange="nfpEditor.resizeCanvas()">
                </div>
                <div class="property-field">
                    <label>Height</label>
                    <input type="number" id="canvasHeight" value="48" min="1" max="200" onchange="nfpEditor.resizeCanvas()">
                </div>
            </div>

            <!-- Export Settings -->
            <div class="property-group">
                <h4>üíæ Export</h4>
                <div class="property-field">
                    <label>Filename</label>
                    <input type="text" id="filename" value="image.nfp" placeholder="image.nfp">
                </div>
                <div class="property-field">
                    <label>Format</label>
                    <select id="exportFormat">
                        <option value="nfp">NFP Format</option>
                        <option value="lua">Lua Table</option>
                        <option value="raw">Raw Text</option>
                    </select>
                </div>
            </div>

            <!-- NFP Preview -->
            <div class="preview-section">
                <div class="preview-title">üìÑ NFP Preview</div>
                <div class="nfp-preview" id="nfpPreview">Click canvas to see preview</div>
            </div>

            <!-- Help -->
            <div class="property-group">
                <h4>‚ùì Help</h4>
                <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5;">
                    <p><strong>Tools:</strong></p>
                    <p>‚Ä¢ Brush: Paint pixels</p>
                    <p>‚Ä¢ Fill: Flood fill area</p>
                    <p>‚Ä¢ Line: Draw straight lines</p>
                    <p>‚Ä¢ Rectangle: Draw rectangles</p>
                    <br>
                    <p><strong>Controls:</strong></p>
                    <p>‚Ä¢ Left click: Paint/Use tool</p>
                    <p>‚Ä¢ Right click: Erase</p>
                    <p>‚Ä¢ Scroll: Zoom in/out</p>
                    <p>‚Ä¢ Space: Pan canvas</p>
                </div>
            </div>
        </aside>
    </div>

    <script>
        class NFPEditor {
            constructor() {
                this.canvas = document.getElementById('nfpCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.width = 64;
                this.height = 48;
                this.zoom = 10;
                this.showGrid = false;
                this.currentTool = 'brush';
                this.currentColor = ' '; // transparent
                this.isDrawing = false;
                this.pixels = {};
                this.startX = 0;
                this.startY = 0;
                
                this.initializeCanvas();
                this.setupEventListeners();
                this.updatePreview();
            }

            initializeCanvas() {
                this.canvas.width = this.width * this.zoom;
                this.canvas.height = this.height * this.zoom;
                this.ctx.imageSmoothingEnabled = false;
                this.redraw();
            }

            setupEventListeners() {
                // Canvas events
                this.canvas.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                this.canvas.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                this.canvas.addEventListener('mouseup', (e) => this.handleMouseUp(e));
                this.canvas.addEventListener('contextmenu', (e) => e.preventDefault());
                this.canvas.addEventListener('wheel', (e) => this.handleWheel(e));

                // Tool selection
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelector('.tool-btn.active').classList.remove('active');
                        btn.classList.add('active');
                        this.currentTool = btn.dataset.tool;
                    });
                });

                // Color selection
                document.querySelectorAll('.color-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelector('.color-btn.active').classList.remove('active');
                        btn.classList.add('active');
                        this.currentColor = btn.dataset.color;
                    });
                });

                // File drag and drop
                this.canvas.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                });

                this.canvas.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.loadFileFromInput(files[0]);
                    }
                });
            }

            getMousePos(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = Math.floor((e.clientX - rect.left) / this.zoom);
                const y = Math.floor((e.clientY - rect.top) / this.zoom);
                
                // Update position display
                document.getElementById('mousePos').textContent = `Position: ${x}, ${y}`;
                
                return { x, y };
            }

            handleMouseDown(e) {
                if (e.button === 0) { // Left click
                    this.isDrawing = true;
                    const pos = this.getMousePos(e);
                    this.startX = pos.x;
                    this.startY = pos.y;
                    
                    if (this.currentTool === 'brush') {
                        this.setPixel(pos.x, pos.y, this.currentColor);
                    } else if (this.currentTool === 'fill') {
                        this.floodFill(pos.x, pos.y, this.currentColor);
                    } else if (this.currentTool === 'eyedropper') {
                        const color = this.getPixel(pos.x, pos.y);
                        this.selectColor(color);
                    }
                } else if (e.button === 2) { // Right click
                    const pos = this.getMousePos(e);
                    this.setPixel(pos.x, pos.y, ' '); // Erase
                }
            }

            handleMouseMove(e) {
                this.getMousePos(e); // Update position display
                
                if (!this.isDrawing) return;
                
                const pos = this.getMousePos(e);
                
                if (this.currentTool === 'brush') {
                    this.setPixel(pos.x, pos.y, this.currentColor);
                }
            }

            handleMouseUp(e) {
                if (!this.isDrawing) return;
                this.isDrawing = false;
                
                const pos = this.getMousePos(e);
                
                if (this.currentTool === 'line') {
                    this.drawLine(this.startX, this.startY, pos.x, pos.y, this.currentColor);
                } else if (this.currentTool === 'rectangle') {
                    this.drawRectangle(this.startX, this.startY, pos.x, pos.y, this.currentColor);
                } else if (this.currentTool === 'circle') {
                    this.drawCircle(this.startX, this.startY, pos.x, pos.y, this.currentColor);
                }
            }

            handleWheel(e) {
                e.preventDefault();
                if (e.deltaY < 0) {
                    this.zoomIn();
                } else {
                    this.zoomOut();
                }
            }

            setPixel(x, y, color) {
                if (x < 0 || x >= this.width || y < 0 || y >= this.height) return;
                
                if (color === ' ') {
                    delete this.pixels[`${x},${y}`];
                } else {
                    this.pixels[`${x},${y}`] = color;
                }
                
                this.redrawPixel(x, y);
                this.updatePreview();
            }

            getPixel(x, y) {
                return this.pixels[`${x},${y}`] || ' ';
            }

            floodFill(x, y, newColor) {
                const originalColor = this.getPixel(x, y);
                if (originalColor === newColor) return;
                
                const stack = [[x, y]];
                const visited = new Set();
                
                while (stack.length > 0) {
                    const [cx, cy] = stack.pop();
                    const key = `${cx},${cy}`;
                    
                    if (visited.has(key)) continue;
                    if (cx < 0 || cx >= this.width || cy < 0 || cy >= this.height) continue;
                    if (this.getPixel(cx, cy) !== originalColor) continue;
                    
                    visited.add(key);
                    this.setPixel(cx, cy, newColor);
                    
                    stack.push([cx + 1, cy], [cx - 1, cy], [cx, cy + 1], [cx, cy - 1]);
                }
            }

            drawLine(x0, y0, x1, y1, color) {
                const dx = Math.abs(x1 - x0);
                const dy = Math.abs(y1 - y0);
                const sx = x0 < x1 ? 1 : -1;
                const sy = y0 < y1 ? 1 : -1;
                let err = dx - dy;
                
                while (true) {
                    this.setPixel(x0, y0, color);
                    
                    if (x0 === x1 && y0 === y1) break;
                    
                    const e2 = 2 * err;
                    if (e2 > -dy) {
                        err -= dy;
                        x0 += sx;
                    }
                    if (e2 < dx) {
                        err += dx;
                        y0 += sy;
                    }
                }
            }

            drawRectangle(x0, y0, x1, y1, color) {
                const minX = Math.min(x0, x1);
                const maxX = Math.max(x0, x1);
                const minY = Math.min(y0, y1);
                const maxY = Math.max(y0, y1);
                
                for (let x = minX; x <= maxX; x++) {
                    for (let y = minY; y <= maxY; y++) {
                        if (x === minX || x === maxX || y === minY || y === maxY) {
                            this.setPixel(x, y, color);
                        }
                    }
                }
            }

            drawCircle(x0, y0, x1, y1, color) {
                const radius = Math.round(Math.sqrt((x1 - x0) ** 2 + (y1 - y0) ** 2));
                let x = radius;
                let y = 0;
                let err = 0;
                
                while (x >= y) {
                    this.setPixel(x0 + x, y0 + y, color);
                    this.setPixel(x0 + y, y0 + x, color);
                    this.setPixel(x0 - y, y0 + x, color);
                    this.setPixel(x0 - x, y0 + y, color);
                    this.setPixel(x0 - x, y0 - y, color);
                    this.setPixel(x0 - y, y0 - x, color);
                    this.setPixel(x0 + y, y0 - x, color);
                    this.setPixel(x0 + x, y0 - y, color);
                    
                    if (err <= 0) {
                        y += 1;
                        err += 2 * y + 1;
                    }
                    
                    if (err > 0) {
                        x -= 1;
                        err -= 2 * x + 1;
                    }
                }
            }

            selectColor(color) {
                this.currentColor = color;
                document.querySelector('.color-btn.active').classList.remove('active');
                const colorBtn = document.querySelector(`[data-color="${color}"]`);
                if (colorBtn) {
                    colorBtn.classList.add('active');
                }
            }

            redraw() {
                this.ctx.fillStyle = '#222';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw all pixels
                for (let y = 0; y < this.height; y++) {
                    for (let x = 0; x < this.width; x++) {
                        this.redrawPixel(x, y);
                    }
                }
                
                // Draw grid if enabled
                if (this.showGrid) {
                    this.drawGrid();
                }
            }

            redrawPixel(x, y) {
                const color = this.getPixel(x, y);
                if (color !== ' ') {
                    this.ctx.fillStyle = this.getColorHex(color);
                    this.ctx.fillRect(x * this.zoom, y * this.zoom, this.zoom, this.zoom);
                }
            }

            drawGrid() {
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                this.ctx.lineWidth = 1;
                
                for (let x = 0; x <= this.width; x++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x * this.zoom, 0);
                    this.ctx.lineTo(x * this.zoom, this.height * this.zoom);
                    this.ctx.stroke();
                }
                
                for (let y = 0; y <= this.height; y++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y * this.zoom);
                    this.ctx.lineTo(this.width * this.zoom, y * this.zoom);
                    this.ctx.stroke();
                }
            }

            getColorHex(colorCode) {
                const colors = {
                    '0': '#f0f0f0', '1': '#f2b233', '2': '#e57fd8', '3': '#99b2f2',
                    '4': '#dede6c', '5': '#7fcc19', '6': '#f2b2cc', '7': '#4c4c4c',
                    '8': '#999999', '9': '#4c99b2', 'a': '#b266e5', 'b': '#3366cc',
                    'c': '#7f664c', 'd': '#57a64e', 'e': '#cc4c4c', 'f': '#191919'
                };
                return colors[colorCode] || '#222';
            }

            updatePreview() {
                const nfp = this.generateNFP();
                document.getElementById('nfpPreview').textContent = nfp;
            }

            generateNFP() {
                let result = '';
                let hasContent = false;
                
                for (let y = 0; y < this.height; y++) {
                    let line = '';
                    let lineHasContent = false;
                    
                    for (let x = 0; x < this.width; x++) {
                        const pixel = this.getPixel(x, y);
                        line += pixel;
                        if (pixel !== ' ') {
                            lineHasContent = true;
                            hasContent = true;
                        }
                    }
                    
                    // Remove trailing spaces
                    line = line.replace(/\s+$/, '');
                    
                    if (lineHasContent || hasContent) {
                        result += line + '\n';
                    }
                }
                
                return result.replace(/\n+$/, ''); // Remove trailing newlines
            }

            loadNFP(nfpData) {
                this.pixels = {};
                const lines = nfpData.split('\n');
                
                // Find the actual dimensions
                let maxWidth = 0;
                let height = lines.length;
                
                for (let y = 0; y < lines.length; y++) {
                    const line = lines[y];
                    maxWidth = Math.max(maxWidth, line.length);
                    
                    for (let x = 0; x < line.length; x++) {
                        const char = line[x];
                        if (char !== ' ') {
                            this.pixels[`${x},${y}`] = char;
                        }
                    }
                }
                
                // Update canvas size if needed
                if (maxWidth > this.width || height > this.height) {
                    this.width = Math.max(maxWidth, this.width);
                    this.height = Math.max(height, this.height);
                    document.getElementById('canvasWidth').value = this.width;
                    document.getElementById('canvasHeight').value = this.height;
                    this.resizeCanvas();
                }
                
                this.redraw();
                this.updatePreview();
            }

            loadFile(event) {
                const file = event.target.files[0];
                if (file) {
                    this.loadFileFromInput(file);
                }
            }

            loadFileFromInput(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        this.loadNFP(e.target.result);
                    } catch (error) {
                        alert('Error loading file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            exportNFP() {
                const format = document.getElementById('exportFormat').value;
                const filename = document.getElementById('filename').value || 'image.nfp';
                
                let content = '';
                let mimeType = 'text/plain';
                
                if (format === 'nfp') {
                    content = this.generateNFP();
                } else if (format === 'lua') {
                    content = this.generateLuaTable();
                } else if (format === 'raw') {
                    content = this.generateRawText();
                }
                
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            generateLuaTable() {
                const lines = [];
                for (let y = 0; y < this.height; y++) {
                    let line = '"';
                    for (let x = 0; x < this.width; x++) {
                        line += this.getPixel(x, y);
                    }
                    line = line.replace(/\s+$/, ''); // Remove trailing spaces
                    line += '"';
                    lines.push(line);
                }
                return `local image = {\n  ${lines.join(',\n  ')}\n}`;
            }

            generateRawText() {
                return this.generateNFP();
            }

            newCanvas() {
                if (confirm('Create a new canvas? This will clear the current image.')) {
                    this.pixels = {};
                    this.redraw();
                    this.updatePreview();
                }
            }

            clearCanvas() {
                if (confirm('Clear the entire canvas?')) {
                    this.pixels = {};
                    this.redraw();
                    this.updatePreview();
                }
            }

            resizeCanvas() {
                const newWidth = parseInt(document.getElementById('canvasWidth').value);
                const newHeight = parseInt(document.getElementById('canvasHeight').value);
                
                if (newWidth > 0 && newHeight > 0) {
                    this.width = newWidth;
                    this.height = newHeight;
                    this.canvas.width = this.width * this.zoom;
                    this.canvas.height = this.height * this.zoom;
                    document.getElementById('canvasSize').textContent = `Canvas: ${this.width}√ó${this.height}`;
                    this.redraw();
                    this.updatePreview();
                }
            }

            toggleGrid() {
                this.showGrid = !this.showGrid;
                const toggle = document.getElementById('gridToggle');
                toggle.classList.toggle('active', this.showGrid);
                this.redraw();
            }

            zoomIn() {
                if (this.zoom < 50) {
                    this.zoom += 2;
                    this.updateZoom();
                }
            }

            zoomOut() {
                if (this.zoom > 2) {
                    this.zoom -= 2;
                    this.updateZoom();
                }
            }

            updateZoom() {
                this.canvas.width = this.width * this.zoom;
                this.canvas.height = this.height * this.zoom;
                document.getElementById('zoomLevel').textContent = `${Math.round(this.zoom * 10)}%`;
                this.redraw();
            }
        }

        // Initialize editor when page loads
        let nfpEditor;
        window.addEventListener('DOMContentLoaded', () => {
            nfpEditor = new NFPEditor();
            
            // Load example NFP
            const exampleNFP = `           33    333333
            333333     33
            33333333333333
          33333333333333 33
          33 3  333  3333 3   1111
          33 3   3 353  3333 11
          33333   335333333   55555
           33333333355555555555
              3333333333 3333
                            333
                              3333
                                  333333`;
            
            nfpEditor.loadNFP(exampleNFP);
        });
    </script>
</body>
</html>
